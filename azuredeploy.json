{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "initials": {
        "type": "string",
        "metadata": {
          "description": "Small unique string."
        },
        "minLength": 2,
        "maxLength": 5
      },
      "servicePrincipalClientId": {
        "type": "string",
        "metadata": {
          "description": "ObjectId for User allowed KeyVault Secret Access. (az ad user show --upn user@email.com)"
        }
      },
      "servicePrincipalClientKey": {
        "type": "string",
        "metadata": {
          "description": "ObjectId for User allowed KeyVault Secret Access. (az ad user show --upn user@email.com)"
        }
      },
      "templateURL": {
          "type": "string",
          "metadata": {
              "description": "URL Location on where to find the templates"
          },
          "defaultValue": "https://raw.githubusercontent.com/danielscholl/azure-ipc-arch/master/templates/"
      },
      "adminUserName": {
        "type": "string",
        "metadata": {
          "description": "Admin user account name."
        },
        "minLength": 5
      },
      "adminSshKey": {
        "type": "securestring",
        "metadata": {
          "description": "Admin user public ssh key."
        }
      },
      "dbUserName": {
          "type": "string",
          "metadata": {
              "description": "Database SA Account UserName"
          },
          "minLength": 5
      },
      "dbPasword": {
          "type": "securestring",
          "metadata": {
              "description": "Database SA Account Password"
          },
          "minLength": 10
      }
    },
    "variables": {},
    "resources": [
      {
        "name": "TemplateStorage",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(parameters('templateURL'), 'deployStorageAccount.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "storageAccountType": {
              "value": "Standard_LRS"
            }
          }
        }
      },
      {
        "name": "TemplateKeyVault",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(parameters('templateURL'), 'deployKeyVault.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "unique": {
              "value": "[parameters('initials')]"
            },
            "servicePrincipalAppId": {
              "value": "[parameters('servicePrincipalClientId')]"
            },
            "servicePrincipalClientKey": {
                "value": "[parameters('servicePrincipalClientKey')]"
              },
            "adminUserName": {
              "value": "[parameters('adminUserName')]"
            },
            "publicSSHKeyData": {
              "value": "[parameters('adminSshKey')]"
            },
            "dbUserName": {
                "value": "[parameters('dbUserName')]"
            },
            "dbPassword": {
                "value": "[parameters('dbPasword')]"
            }
          }
        }
      }
    ],
    "outputs": {
      "storageAccount": {
        "type": "object",
        "value": "[reference('TemplateStorage').outputs.storageAccount.value]"
      },
      "keyVault": {
        "type": "object",
        "value": "[reference('TemplateKeyVault').outputs.keyVault.value]"
      }
    }
  }